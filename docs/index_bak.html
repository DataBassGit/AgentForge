<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown Directory Browser</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.3.2/markdown-it.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it-highlightjs/3.6.0/markdown-it-highlightjs.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
      background-color: #1e1e1e;
      color: #e0e0e0;
    }
    #nav-panel {
      width: 250px;
      height: 100%;
      background-color: #252526;
      border-right: 1px solid #3e3e42;
      overflow-y: auto;
      padding: 15px;
    }
    #nav-panel h3 {
      margin-bottom: 15px;
      color: #e0e0e0;
    }
    #directory-tree ul {
      list-style-type: none;
      padding-left: 15px;
    }
    #directory-tree li {
      position: relative;
      padding: 3px 0;
    }
    #directory-tree li span {
      cursor: pointer;
      display: inline-block;
      padding: 2px 5px;
      border-radius: 3px;
    }
    #directory-tree li span:hover {
      background-color: #3e3e42;
    }
    #directory-tree li span.selected {
      background-color: #0e639c;
      color: white;
    }
    #directory-tree li.folder > span::before {
      content: 'ðŸ“ ';
    }
    #directory-tree li.folder.open > span::before {
      content: 'ðŸ“‚ ';
    }
    #directory-tree li.file > span::before {
      content: 'ðŸ“„ ';
    }
    #directory-tree li.file.markdown > span::before {
      content: 'ðŸ“ ';
    }
    #content-area {
      flex: 1;
      height: 100%;
      overflow-y: auto;
      padding: 20px;
      background-color: #1e1e1e;
    }
    #status-message {
      background-color: #252526;
      border-left: 4px solid #0e639c;
      padding: 10px 15px;
      margin-bottom: 15px;
      display: none;
    }
    #status-message.error {
      border-left: 4px solid #f44336;
    }
    .markdown-body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      word-wrap: break-word;
      color: #e0e0e0;
    }
    .markdown-body h1, .markdown-body h2 {
      border-bottom: 1px solid #3e3e42;
      padding-bottom: 0.3em;
      margin-top: 24px;
      margin-bottom: 16px;
    }
    .markdown-body h1 {
      font-size: 2em;
    }
    .markdown-body h2 {
      font-size: 1.5em;
    }
    .markdown-body h3 {
      font-size: 1.25em;
      margin-top: 24px;
      margin-bottom: 16px;
    }
    .markdown-body h4 {
      font-size: 1em;
      margin-top: 24px;
      margin-bottom: 16px;
    }
    .markdown-body p, .markdown-body ul, .markdown-body ol {
      margin-bottom: 16px;
    }
    .markdown-body code {
      font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
      padding: 0.2em 0.4em;
      background-color: #2c2c2c;
      border-radius: 3px;
    }
    .markdown-body pre {
      background-color: #2c2c2c;
      border-radius: 3px;
      padding: 16px;
      overflow: auto;
      margin-bottom: 16px;
    }
    .markdown-body pre > code {
      background-color: transparent;
      padding: 0;
    }
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      #nav-panel {
        width: 100%;
        height: 200px;
        border-right: none;
        border-bottom: 1px solid #3e3e42;
      }
      #content-area {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div id="nav-panel">
    <h3>Directory Navigation</h3>
    <div id="directory-tree"></div>
  </div>
  <div id="content-area">
    <div id="status-message"></div>
    <div id="markdown-content" class="markdown-body">
      <h1>Welcome to Markdown Directory Browser</h1>
      <p>Select a markdown file from the navigation panel to display its content here.</p>
    </div>
  </div>

  <script>
    // Initialize markdown-it
    const md = window.markdownit({
      html: true,
      linkify: true,
      typographer: true,
    });

    // Correctly register the highlight plugin by checking for a default export
    if (window.markdownitHighlightjs) {
      let highlightPlugin = window.markdownitHighlightjs;
      if (highlightPlugin.default) {
        highlightPlugin = highlightPlugin.default;
      }
      md.use(highlightPlugin, { hljs: window.hljs });
    } else {
      console.error("Initialization error: markdown-it-highlightjs not loaded");
      document.addEventListener("DOMContentLoaded", () => {
          const statusElement = document.getElementById("status-message");
          statusElement.textContent = "Initialization error: markdown-it-highlightjs not loaded";
          statusElement.classList.add("error");
          statusElement.style.display = "block";
      });
    }

    let currentFile = null;
    let currentDir = null;

    const supportsFileSystemAccess = 'showDirectoryPicker' in window &&
      (() => { try { return window.self === window.top; } catch { return false; } })();

    function showStatus(message, isError = false) {
      const statusElement = document.getElementById('status-message');
      statusElement.textContent = message;
      statusElement.style.display = 'block';
      if (isError) {
        statusElement.classList.add('error');
      } else {
        statusElement.classList.remove('error');
      }
      if (!isError) {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }

    async function init() {
      const navPanel = document.getElementById('nav-panel');
      const button = document.createElement('button');
      button.textContent = 'Open Directory';
      button.style.backgroundColor = '#0e639c';
      button.style.color = 'white';
      button.style.border = 'none';
      button.style.padding = '8px 12px';
      button.style.borderRadius = '4px';
      button.style.cursor = 'pointer';
      button.style.marginBottom = '15px';

      navPanel.insertBefore(button, navPanel.firstChild);

      if (supportsFileSystemAccess) {
        button.onclick = openDirectoryWithFileSystemAPI;
        showStatus('File System Access API is supported.', false);
      } else {
        const input = document.createElement('input');
        input.type = 'file';
        input.webkitdirectory = true;
        input.style.display = 'none';
        input.onchange = handleDirectorySelection;
        button.onclick = () => input.click();
        navPanel.appendChild(input);
        showStatus('Using fallback directory selection method.', false);
      }
    }

    async function openDirectoryWithFileSystemAPI() {
      try {
        showStatus('Opening directory picker...', false);
        const directoryHandle = await window.showDirectoryPicker();
        currentDir = directoryHandle;
        showStatus('Reading directory...', false);
        await buildDirectoryTree(directoryHandle);
        showStatus('Directory loaded successfully.', false);
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Error opening directory:', error);
          showStatus('Error opening directory: ' + error.message, true);
        } else {
          showStatus('Directory selection cancelled.', false);
        }
      }
    }

    async function buildDirectoryTree(directoryHandle) {
      const directoryStructure = document.getElementById('directory-tree');
      directoryStructure.innerHTML = '';
      const ul = document.createElement('ul');
      directoryStructure.appendChild(ul);
      try {
        await addDirectoryContents(directoryHandle, ul);
      } catch (error) {
        console.error('Error building directory tree:', error);
        showStatus('Error building directory tree: ' + error.message, true);
      }
    }

    async function addDirectoryContents(directoryHandle, parentElement, path = '') {
      try {
        const entries = [];
        for await (const entry of directoryHandle.values()) {
          entries.push(entry);
        }
        entries.sort((a, b) => {
          if (a.kind === 'directory' && b.kind !== 'directory') return -1;
          if (a.kind !== 'directory' && b.kind === 'directory') return 1;
          return a.name.localeCompare(b.name);
        });
        for (const entry of entries) {
          const li = document.createElement('li');
          const span = document.createElement('span');
          span.textContent = entry.name;
          if (entry.kind === 'directory') {
            li.classList.add('folder');
            span.onclick = async () => {
              if (li.classList.contains('open')) {
                li.classList.remove('open');
                Array.from(li.children).forEach(child => {
                  if (child !== span) li.removeChild(child);
                });
              } else {
                li.classList.add('open');
                const subUl = document.createElement('ul');
                li.appendChild(subUl);
                showStatus('Loading directory contents...', false);
                await addDirectoryContents(entry, subUl, path + entry.name + '/');
                showStatus('Directory contents loaded.', false);
              }
            };
          } else if (entry.kind === 'file') {
            li.classList.add('file');
            if (entry.name.endsWith('.md')) {
              li.classList.add('markdown');
              span.onclick = async () => {
                document.querySelectorAll('#directory-tree span.selected').forEach(el => {
                  el.classList.remove('selected');
                });
                span.classList.add('selected');
                try {
                  showStatus('Loading markdown file...', false);
                  const file = await entry.getFile();
                  const content = await file.text();
                  const htmlContent = md.render(content);
                  document.getElementById('markdown-content').innerHTML = htmlContent;
                  currentFile = entry;
                  showStatus('Markdown file loaded successfully.', false);
                } catch (error) {
                  console.error('Error loading markdown file:', error);
                  showStatus('Error loading markdown file: ' + error.message, true);
                }
              };
            }
          }
          li.appendChild(span);
          parentElement.appendChild(li);
        }
      } catch (error) {
        console.error('Error processing directory contents:', error);
        showStatus('Error processing directory contents: ' + error.message, true);
      }
    }

    function handleDirectorySelection(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) {
        showStatus('No files selected.', false);
        return;
      }
      showStatus('Building directory structure...', false);
      try {
        const directoryStructure = buildDirectoryStructureFromFiles(files);
        renderDirectoryTree(directoryStructure);
        showStatus('Directory loaded successfully.', false);
      } catch (error) {
        console.error('Error building directory structure:', error);
        showStatus('Error building directory structure: ' + error.message, true);
      }
    }

    function buildDirectoryStructureFromFiles(files) {
      const structure = {};
      for (const file of files) {
        const pathParts = file.webkitRelativePath.split('/');
        let current = structure;
        for (let i = 0; i < pathParts.length; i++) {
          const part = pathParts[i];
          if (i === pathParts.length - 1) {
            current[part] = file;
          } else {
            current[part] = current[part] || {};
            current = current[part];
          }
        }
      }
      return structure;
    }

    function renderDirectoryTree(structure, parentElement = document.getElementById('directory-tree')) {
      for (const [name, value] of Object.entries(structure)) {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = name;
        li.appendChild(span);
        if (value instanceof File) {
          li.classList.add('file');
          if (name.endsWith('.md')) {
            li.classList.add('markdown');
            span.onclick = () => loadMarkdownFile(value);
          }
        } else {
          li.classList.add('folder');
          const ul = document.createElement('ul');
          li.appendChild(ul);
          renderDirectoryTree(value, ul);
          span.onclick = () => {
            li.classList.toggle('open');
          };
        }
        parentElement.appendChild(li);
      }
    }

    async function loadMarkdownFile(file) {
      try {
        showStatus('Loading markdown file...', false);
        const content = await file.text();
        const htmlContent = md.render(content);
        document.getElementById('markdown-content').innerHTML = htmlContent;
        showStatus('Markdown file loaded successfully.', false);
      } catch (error) {
        console.error('Error loading markdown file:', error);
        showStatus('Error loading markdown file: ' + error.message, true);
      }
    }

    init();
  </script>
</body>
</html>
